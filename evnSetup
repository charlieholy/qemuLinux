sudo apt update && sudo apt install -y qemu-system-arm qemu-utils gcc-arm-linux-gnueabihf gcc-aarch64-linux-gnu device-tree-compiler busybox-static build-essential libncurses5-dev flex bison wget unzip openssh-server


export ARCH=arm 
export CROSS_COMPILE=arm-
make vexpress_defconfig  
make zImage  
make vexpress-v2p-ca9.dtb

busybox


cd ~
wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
tar -xvf busybox-1.36.1.tar.bz2
cd busybox-1.36.1

# 配置 BusyBox
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- defconfig
# 启用静态编译（关键：无需动态库）
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- menuconfig
# 勾选：Settings -> Build static binary (no shared libs)

# 编译并安装 BusyBox
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- install -j$(nproc)
# 创建根文件系统目录
mkdir -p ~/rootfs
cd ~/rootfs
# 复制 BusyBox 生成的文件
cp -r ~/busybox-1.36.1/_install/* ./

# 创建必要目录
mkdir -p dev proc sys tmp etc/init.d mnt root

# 创建 init 启动脚本（核心）
cat > etc/init.d/rcS << EOF
#!/bin/sh
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t tmpfs tmpfs /tmp
mdev -s  # 自动创建设备节点
echo "Welcome to QEMU ARM Linux!"
EOF

# 赋予执行权限
chmod +x etc/init.d/rcS

# 创建 inittab（指定启动脚本）
cat > etc/inittab << EOF
::sysinit:/etc/init.d/rcS
::respawn:/bin/sh
::ctrlaltdel:/sbin/reboot
EOF

# 创建设备节点（控制台/串口）
sudo mknod dev/console c 5 1
sudo mknod dev/ttyAMA0 c 204 64  # QEMU 串口节点



dd if=/dev/zero of=a64rootfs.ext4 bs=1M count=128
# 3. 格式化空镜像为ext4格式（必须格式化，否则无法挂载和使用）
sudo mkfs.ext4 a64rootfs.ext4
# 4. 创建临时挂载目录（已创建可跳过）
mkdir -p tmp_mount
# 5. 挂载新建的空ext4镜像到tmp_mount
sudo mount a64rootfs.ext4 tmp_mount/
# 6. 复制a64rootfs目录下所有文件到镜像中（保留文件权限和结构）
sudo cp -rf a64rootfs/* tmp_mount/
# 7. 同步数据（确保所有文件写入镜像，避免丢失）
sudo sync
# 8. 卸载镜像（完成打包）
sudo umount tmp_mount/

root@iZbp18b84buehuy2ylm0joZ:/var/fpwork/pechen/linux# cat run.sh 
QEMU_AUDIO_DRV=none qemu-system-arm \
  -M vexpress-a9 \
  -kernel linux-5.15.50/arch/arm/boot/zImage \
  -dtb linux-5.15.50/arch/arm/boot/dts/vexpress-v2p-ca9.dtb \
  -sd busybox/rootfs.ext4 \
  -append "root=/dev/mmcblk0 rw console=ttyAMA0,115200 init=/linuxrc ignore_loglevel" \
  -m 512M \
  -nographic
